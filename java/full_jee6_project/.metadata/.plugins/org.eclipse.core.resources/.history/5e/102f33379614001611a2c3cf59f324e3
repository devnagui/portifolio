package br.com.devnagui.project.manager.impl;

import java.io.Serializable;
import java.lang.reflect.ParameterizedType;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.PersistenceException;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Order;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;

import org.apache.log4j.Logger;
import org.hibernate.Hibernate;

import br.com.devnagui.project.dto.PageObjectDTO;
import br.com.devnagui.project.manager.GenericoManager;
import br.com.devnagui.project.manager.exception.BusinessException;

/**
 * 
 * Created by Me :D
 * 
 * @param <Entity>
 */
public class GenericManagerBean<Entity extends Serializable> implements GenericoManager<Entity> {
	/**
	 * Serial UID.
	 */
	private static final long serialVersionUID = -7759790807104078131L;
	
	protected static final int STANDARD_MAX_RESULT = 10;

	private static final Logger LOG = Logger.getLogger(GenericManagerBean.class);

	@PersistenceContext(name = "projectPU")
	private EntityManager entityManager;

	private Class<Entity> entityClass;

	public GenericManagerBean() {

	}

	/**
	 * @param entityManager2
	 * @param classEntidade
	 */
	public GenericManagerBean(EntityManager entityManager2, Class<Entity> classEntidade) {
		this.entityManager = entityManager2;
		this.entityClass = classEntidade;
	}

	@SuppressWarnings("unchecked")
	protected Class<Entity> getEntityClass() {

		if (entityClass != null) {
			return entityClass;
		}
		return (Class<Entity>) ((ParameterizedType) this.getClass().getGenericSuperclass()).getActualTypeArguments()[0];
	}

	protected String getEntityName() {
		return getEntityManager().getMetamodel().entity(getEntityClass()).getName();
	}

	@Override
	public void insert(Entity entity) throws BusinessException {
	    LOG.info("Inserindo entidade.");
        try {

			getEntityManager().persist(entity);
		} catch (PersistenceException e) {
			LOG.error("Erro ao inserir a entidade  - " + getEntityClass(), e);
			throw new BusinessException(e);
		}
	}

	@Override
	public Entity update(Entity entity) throws BusinessException {
	    LOG.info("Alterando entidade.");
	    
		try {
			Entity entidadeAtualizada = getEntityManager().merge(entity);
			getEntityManager().flush();
			return entidadeAtualizada;
		} catch (PersistenceException e) {
			LOG.error("Erro ao atualizar a entidade  - " + getEntityClass(), e);
			throw new BusinessException(e);
		}

	}

	@Override
	public void remove(Entity entity) throws BusinessException {
	    LOG.info("Excluindo entidade.");
		try {
		    entity=getEntityManager().merge(entity);
			getEntityManager().remove(entity);
		} catch (PersistenceException e) {
			LOG.error("Erro ao apagar a entidade - " + getEntityClass(), e);
			throw new BusinessException(e);
		}
	}

	@Override
	public void refresh(Entity entity) throws BusinessException {
	    LOG.info("Recarregando entidade.");
        
		try {
			getEntityManager().refresh(entity);
		} catch (PersistenceException e) {
			LOG.error("Erro ao recarregar a entidade - " + getEntityClass(), e);
			throw new BusinessException(e);
		}
	}

	@Override
	public void detach(Entity entity) throws BusinessException {
	    LOG.info("Removendo entidade do contexto.");
        
		try {
			getEntityManager().detach(entity);
		} catch (PersistenceException e) {
			LOG.error("Erro ao remover entidade do contexto de persistencia - " + getEntityClass(), e);
			throw new BusinessException(e);
		}
	}

	@Override
	public Entity searchForId(Long id) throws BusinessException {
	    LOG.info("Buscando entidade por id.");
        
		try {
			return getEntityManager().find(getEntityClass(), id);
		} catch (PersistenceException e) {
			LOG.error("Erro ao buscar a entidade.", e);
			throw new BusinessException(e);
		}
	}

	@Override
	public List<Entity> getAll() throws BusinessException {
	    LOG.info("Obtendo todas as entidades.");
        
		try {
			CriteriaBuilder builder = getEntityManager().getCriteriaBuilder();
			CriteriaQuery<Entity> cQuery = builder.createQuery(getEntityClass());
			Root<Entity> from = cQuery.from(getEntityClass());
			CriteriaQuery<Entity> select = cQuery.select(from);
			// Added orderBy clause
			TypedQuery<Entity> typedQuery = getEntityManager().createQuery(select);
			return typedQuery.getResultList();
		} catch (PersistenceException e) {
			LOG.error("Erro ao buscar todas as entidade.", e);
			throw new BusinessException(e);
		}
	}

	@Override
	public PageObjectDTO<Entity> getSimplePagedList(PageObjectDTO<Entity> pageObject) throws BusinessException {
	    LOG.info("Default paging without filters.");
        
		try {
			List<Entity> pagedData = retrivePagedData(pageObject);
			pageObject.setDados(pagedData);

			int pageLength = getTotalEntitiesForPagination(pageObject);
			pageObject.setPageLength(pageLength);

			return pageObject;
		} catch (PersistenceException e) {
			LOG.error("Erro ao paginar lista de entidades - " + getEntityClass(), e);
			throw new BusinessException(e);
		}
	}
	
	protected List<Entity> retrivePagedData(final PageObjectDTO<Entity> pagedObject) {
        CriteriaBuilder builder = getEntityManager().getCriteriaBuilder();
        CriteriaQuery<Entity> cQuery = builder.createQuery(getEntityClass());
        Root<Entity> entidadeRoot = cQuery.from(getEntityClass());
        cQuery.select(entidadeRoot);
        cQuery.where(construirCondicoesWhere(builder, entidadeRoot,pagedObject));
        cQuery.orderBy(construirOrderBy(builder, entidadeRoot ,pagedObject));
        TypedQuery<Entity> typedQuery = getEntityManager().createQuery(cQuery);
        restrictLength(pagedObject, typedQuery);
        return typedQuery.getResultList();
    }

    
	protected int getTotalEntitiesForPagination(PageObjectDTO<Entity> paginacao) {
	    CriteriaBuilder builder = getEntityManager().getCriteriaBuilder();
        CriteriaQuery<Long> cQuery = builder.createQuery(Long.class);
        Root<Entity> entidadeRoot = cQuery.from(getEntityClass());
        cQuery.select(builder.count(entidadeRoot));
        cQuery.where(construirCondicoesWhere(builder, entidadeRoot, paginacao));
        Long quantidadeTotalRegistros = getEntityManager().createQuery(cQuery).getSingleResult();
        return quantidadeTotalRegistros.intValue();
    }
	
	
	protected void restrictLength(final PageObjectDTO<Entity> paginacao, TypedQuery<Entity> typedQuery) {
        int fromIndex = paginacao.getFromIndex();
        typedQuery.setFirstResult(fromIndex);
        typedQuery.setMaxResults(paginacao.getDatasetLength());
    }
    

	/**
	 * M�todo padr�o para constru��o das condi��es da query utilizada no m�todo
	 * obterListaPaginada Deve ser sobrescrito quando for preciso adicionar
	 * condi��es espec�ficas
	 * @param paginacao 
	 * 
	 */
	protected Predicate construirCondicoesWhere(final CriteriaBuilder builder, final Root<Entity> entidadeRoot, PageObjectDTO<Entity> paginacao) {
		return builder.conjunction();
	}

	/**
	 * M�todo que costroi o OrderBy.
	 * 
	 * @param builder
	 * @param entidadeRoot
	 * @param paginacao - Usado na extenssao para realizar orders mais especializados.
	 * @return Order
	 */
	protected Order construirOrderBy(CriteriaBuilder builder, Root<Entity> entidadeRoot, PageObjectDTO<Entity> paginacao) {
		return builder.asc(entidadeRoot);
	}
	
	public void inicializarObjetoOuColecao(Object colecao) {
	    LOG.info("Inicializando entidade ou colecao.");
        
		Hibernate.initialize(colecao);
	}
	
    
	/**
	 * @return the entityManager
	 */
	public EntityManager getEntityManager() {
		return entityManager;
	};

	/**
	 * @param entityManager
	 *            the entityManager to set
	 */
	public void setEntityManager(EntityManager entityManager) {
		this.entityManager = entityManager;
	}
}