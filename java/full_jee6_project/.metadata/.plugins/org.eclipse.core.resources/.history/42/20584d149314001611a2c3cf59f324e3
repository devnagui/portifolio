package br.com.devnagui.project.webservices.consultanfe.facade;

import java.util.Date;
import java.util.GregorianCalendar;

import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.XMLGregorianCalendar;

import org.apache.log4j.Logger;

import br.com.devnagui.project.manager.exception.BusinessException;
import br.com.devnagui.project.webservices.consultanfe.adapter.NFEAdapter;
import br.com.devnagui.nfecorp.ws.consultas.nfe.ConsultaNfeService;
import br.com.devnagui.nfecorp.ws.consultas.nfe.Destinatario;
import br.com.devnagui.nfecorp.ws.consultas.nfe.Emitente;
import br.com.devnagui.nfecorp.ws.consultas.nfe.Nfe;
import br.com.devnagui.nfecorp.ws.consultas.nfe.Produto;
import br.com.devnagui.nfecorp.ws.consultas.nfe.RetNfe;
import br.com.devnagui.nfecorp.ws.consultas.nfe.Total;

/**
 * 
 * @author 006159C0
 *
 */
public class ConsultarNfeFacade{
	
    private static final Logger LOG = Logger.getLogger(ConsultarNfeFacade.class);


	private br.gov.ce.sefaz.ws.consultas.nfe.ConsultaNfeService consultaNfeService;
	
	public ConsultarNfeFacade() {
		consultaNfeService = new ConsultaNfeService();
	}
	
	/**
	 * Consultar Nfe para a chave de acesso informada pelo usu�rio.	
	 * 
	 * @param chaveAcesso
	 * @return Nfe
	 * @throws BusinessException 
	 */
	public RetNfe consultarNfePorChaveAcesso(String chaveAcesso) throws BusinessException {
		LOG.info("Consultando Nfe para a chave de acesso = " + chaveAcesso);
		RetNfe retornoNFE;
        NFEAdapter nfeAdapter=null;
		try {
        	retornoNFE = consultaNfeService.getConsultaNfePort().consultar(chaveAcesso);
        } catch (Exception e) {
            LOG.error(e.getMessage(),e);
            throw new BusinessException("msg.visita.consultanfe.erroGeral",e);
        }
		return retornoNFE;
	}
	
	private NFEAdapter mockServico(String chave){
		RetNfe retNfe = new RetNfe();
    	Produto produto = new Produto();
    	produto.setCfop(123);
    	produto.setDescricao("Vai pra la Oh vem pra Rock vai pra la!");
    	produto.setQuantidade(40.0);
    	produto.setValorBruto(400.0);
    	produto.setValorUnitario(10.0);
    	retNfe.setCStat("N�o sei a letra sasmibay");
    	retNfe.setXMotivo("Eh shis boday of de blue skiss");
        retNfe.getProdutos().add(produto);
        Nfe nfe = new Nfe();
        Emitente emitente = new Emitente();
        emitente.setCgf("21121");
        emitente.setCnae(121);
        emitente.setCnpj(121212L);
        emitente.setCodMunicipio(212);
        emitente.setCpf(1212121L);
        emitente.setNome("Masld");
        emitente.setSeqNfe(121L);
        emitente.setSiglaUf("as");
        nfe.setEmitente(emitente);
        nfe.setChaveAcesso(chave);
        nfe.setCnpjDestinatario(7346349000129L);
        nfe.setCnpjEmitente(7346349000129L);
        nfe.setCodigoFinalidade(1212121);
        nfe.setCodigoProcessoEmissao(100);
        nfe.setCodigoResultadoEspecifico(100);
        nfe.setCodigoResultadoProcessamento(100);
        nfe.setCodigoTipoDocumento(1);
        nfe.setVersaoAplicativo("trolo lo lo lo lo lo lo");
        nfe.setVersao("sei la ");
        nfe.setSchemaXml("alguma coisa");
        nfe.setTotal(new Total());
        nfe.setTipoDefrete(1);
        nfe.setSeqNfe(454L);
        Destinatario destinatario = new Destinatario();
        destinatario.setCgf("4545454");
        destinatario.setCnpj(7346349000129L);
        destinatario.setCodMunicipio(411);
        destinatario.setCodPais(01);
        destinatario.setCpf(2121252121L);
        destinatario.setNome("Peubes Marley");
        destinatario.setSeqNfe(45454L);
        destinatario.setSiglaUf("12121212sdsd");
    	nfe.setDestinatario(destinatario);
    	GregorianCalendar gregorianCalendar = new GregorianCalendar();
    	gregorianCalendar.setTime(new Date());
    	XMLGregorianCalendar xmlGregorianCalendar=null;
        try {
            xmlGregorianCalendar = DatatypeFactory.newInstance().newXMLGregorianCalendar(gregorianCalendar);
        } catch (DatatypeConfigurationException e) {
            LOG.error(e.getMessage(),e);
        }
		nfe.setDataAutorizacao(xmlGregorianCalendar);
    	nfe.setDataEmissao(xmlGregorianCalendar);
    	nfe.setDataRecebimento(xmlGregorianCalendar);
    	
    	retNfe.setNfe(nfe);
    	
    	NFEAdapter nfeServico = new NFEAdapter(retNfe);
    	return nfeServico;
	}
}
